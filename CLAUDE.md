# CLAUDE.md

This file provides guidance to Claude Code (claude.ai/code) when working with code in this repository.

## Project Overview

This is a **NixOS Configuration** repository managed as a **Nix Flake**. It uses a modular structure powered by [flake-parts](https://flake.parts/) and [flake-file](https://github.com/vic/flake-file) (with `import-tree`), following the [dendritic pattern](https://github.com/mightyiam/dendritic).

### The Dendritic Pattern

The dendritic pattern treats every Nix file as a module of the top-level configuration. Key characteristics:

- **One file = one module**: Each `.nix` file is a complete flake-parts module implementing a single feature
- **Automatic discovery**: Files are auto-imported via import-tree; no manual import list maintenance required
- **Unified value sharing**: All files access the shared top-level config rather than passing values through `specialArgs`
- **File paths convey meaning**: Directory structure directly maps to flake outputs (e.g., `modules/hosts/katara.nix` → `nixosConfigurations.katara`)

### Flake-Parts

Flake-parts is a minimal framework that applies the NixOS module system to flakes. It enables splitting `flake.nix` into focused, reusable units while maintaining compatibility with standard flake attributes. The `flake.nix` in this repo is auto-generated by flake-file and delegates all logic to the `modules/` directory.

## Commands

```bash
# Apply configuration to current machine
sudo nixos-rebuild switch --flake .

# Build a specific host without applying
nix build .#nixosConfigurations.<hostname>.config.system.build.toplevel

# Test a host in QEMU VM (e.g., katara)
nix run .#katara-vm

# Validate all modules and configurations
nix flake check

# Format code
nix fmt

# Update flake inputs
nix flake update
```

## Architecture

### Module Hierarchy

The configuration flows: **Features → Bundles → Profiles → Hosts**

```
Bundles  →  Profiles  →  Hosts
  ↑       ↗    ↑     ↗   ↑
Features    Hardware    Users
```

- **`modules/features/`**: Individual software/service configurations (gnome, neovim, sway, etc.)
- **`modules/bundles/`**: Aggregate related modules into reusable sets (base.nix, desktop.nix). `bundle-base` is the container-safe foundation (fonts, home-manager, locale, nix); `bundle-host` extends it with host-specific modules (auto-upgrade, boot, networking)
- **`modules/profiles/`**: High-level roles combining bundles and features (laptop, developer, server)
- **`modules/hosts/`**: Per-machine configurations that select profiles and set hardware options
- **`modules/users/`**: User account definitions that bridge NixOS and Home Manager; imported by hosts or profiles
- **`modules/hardware/`**: Device and hardware configurations (audio, bluetooth, printing, dell-precision-5680)
- **`modules/core/`**: Core infrastructure (dendritic.nix, home-manager.nix, host-vm.nix)

Features, bundles, and profiles can define both `nixosModules` and `homeModules` in the same file. User modules define both a `nixosModule` (account, groups) and a `homeModule` (packages, programs), wiring them together internally via `home-manager.users.<name>`.

### Layer Import Guidelines

The recommended import direction for each layer. When a change doesn't follow these guidelines, suggest a refactor that does (e.g., creating a profile to wrap features instead of importing them directly from a host).

| Layer | Recommended Imports | Avoid Importing |
|-------|-----------|---------------|
| **Features** | Other features (sparingly) | Bundles, profiles, hosts, users |
| **Bundles** | Features and other bundles | Profiles, hosts, users |
| **Profiles** | Bundles, features, and users | Other profiles, hosts |
| **Hosts** | Profiles, hardware, and users | Features, bundles directly |
| **Users** | Features and profiles (homeModules only) | Bundles, hosts |
| **Hardware** | External hardware modules (nixos-hardware) | Features, bundles, profiles, hosts, users |

### Naming Conventions

- **Hosts**: Avatar: The Last Airbender characters (katara, zuko, appa, momo)

## Development Conventions

- **MCP validation**: MUST use the `nixos` MCP server to verify that packages and options exist before adding them to configurations
- **Module structure**: Modules are functions taking `{ self, inputs, ... }` and define flake outputs directly via `flake.nixosModules.my-feature = { ... };`
- **Imports**: Use `self.nixosModules` to reference other modules: `imports = with self.nixosModules; [ bundle-host gnome ];`
- **flake.nix**: Do not edit manually unless adding new top-level inputs; it is auto-generated by flake-file
- **Formatting**: Run `nix fmt` after making changes to ensure consistent code style
- **Git staging**: Add new files to the git repository (`git add <file>`) before running `nix flake check`, as the flake only sees tracked files
- **Verification**: Run `nix flake check` after formatting and staging to validate the configuration
- **Committing**: Always present changes and proposed commit message to the user for explicit approval before committing
